---
import Icon from "@components/icon.astro";
import type { Icons } from "src/env";

export type Theme = "system" | "dark" | "light";

const themesIcons: Map<Theme, Icons> = new Map([
  ["system", "circle-half"],
  ["dark", "moon-stars-fill"],
  ["light", "sun-fill"],
]);
---

<div id="theme-switcher">
  <button
    class="relative inline-flex items-center gap-2 bg-primary text-white rounded p-3"
    id="theme-toggler"
    data-toggle="dropdown"
    type="button"
    aria-controls="theme-menu"
    aria-haspopup="true"
    aria-expanded="false"
  >
    <Icon name="circle-half" />
    <span class="sr-only">System</span>
    <Icon name="caret-down-fill" />
  </button>
  <ul
    class="absolute md:right-0 hidden p-2 mt-2 border rounded bg-white dark:bg-dark"
    id="theme-menu"
    aria-labelledby="theme-toggler"
    role="menu"
  >
    {
      Array.from(themesIcons.entries()).map(([theme, icon]) => {
        return (
          <li role="presentation">
            <button
              class="inline-flex items-center gap-2 w-full py-1 px-2 rounded hover:bg-primary hover:text-white "
              data-theme-value={theme}
              type="button"
              role="menuitem"
            >
              <Icon name={icon} />
              <span class="capitalize">{theme}</span>
            </button>
          </li>
        );
      })
    }
  </ul>
</div>

<script>
  const rootElement = document.documentElement;

  document.addEventListener("astro:page-load", () => {
    const darkThemeQuery = window.matchMedia("(prefers-color-scheme:dark)");

    const getStoredTheme = () => localStorage.getItem("theme");
    const setStoredTheme = (theme: string) =>
      localStorage.setItem("theme", theme);

    const getPreferredTheme = () => {
      const storedTheme = getStoredTheme();
      if (storedTheme) {
        return storedTheme;
      }

      return darkThemeQuery.matches ? "dark" : "light";
    };

    setTheme(getPreferredTheme());

    function setTheme(theme: string) {
      if (theme === "dark" || (theme === "system" && darkThemeQuery.matches)) {
        rootElement.classList.add("dark");
      } else {
        rootElement.classList.remove("dark");
      }
    }

    function switchTheme(node: HTMLElement) {
      const theme = node.dataset.themeValue;

      switch (theme) {
        case "light":
          setTheme(theme);
          setStoredTheme(theme);

          break;
        case "dark":
          setTheme(theme);
          setStoredTheme(theme);
          break;
        case "system":
          localStorage.removeItem("theme");
          setTheme(getPreferredTheme());
          break;
      }
    }
  });

  document.addEventListener("astro:after-swap", () => {
    if (localStorage.theme === "dark" || !("theme" in localStorage)) {
      rootElement.classList.add("dark");
    } else {
      rootElement.classList.remove("dark");
    }
  });
</script>
